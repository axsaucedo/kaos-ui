name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Standard releases (v1.0.0, v0.1.2, etc)
      - '!v0.0.0*'  # Exclude test tags starting with v0.0.0

# Grant permissions for GitHub Pages deployment and releases
permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

# Prevent concurrent deployments
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # Validate tag format and extract version
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse tag
        id: parse
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.parse.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION (expected X.Y.Z)"
            exit 1
          fi
          echo "✓ Version format valid: $VERSION"

  # Build the release
  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for versioned deployment
        env:
          VITE_BASE: /kaos-ui/v${{ needs.validate.outputs.version }}/
        run: npm run build

      - name: Checkout gh-pages branch
        run: |
          if git fetch origin gh-pages:gh-pages 2>/dev/null; then
            echo "gh-pages branch exists, checking out..."
            git worktree add gh-pages gh-pages
          else
            echo "gh-pages branch does not exist yet"
            mkdir -p gh-pages
          fi

      - name: Prepare deployment directory
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          mkdir -p deploy
          
          # Copy existing gh-pages content if it exists
          if [ -d "gh-pages" ] && [ "$(ls -A gh-pages 2>/dev/null)" ]; then
            echo "Copying existing gh-pages content..."
            cp -r gh-pages/* deploy/ 2>/dev/null || true
            rm -rf deploy/.git deploy/.nojekyll 2>/dev/null || true
          fi
          
          # Add .nojekyll
          touch deploy/.nojekyll
          
          # Deploy to versioned path
          rm -rf "deploy/v${VERSION}"
          mkdir -p "deploy/v${VERSION}"
          cp -r dist/* "deploy/v${VERSION}/"
          
          # Also update /latest/ to this version
          # Rebuild with /latest/ base path
          echo "Rebuilding for /latest/ path..."
          VITE_BASE=/kaos-ui/latest/ npm run build
          rm -rf deploy/latest
          mkdir -p deploy/latest
          cp -r dist/* deploy/latest/
          
          # Ensure redirect index.html exists at root
          cp public/redirect-index.html deploy/index.html
          
          echo "Deployment structure:"
          ls -la deploy/
          echo ""
          echo "Subdirectories:"
          find deploy -maxdepth 1 -type d

      - name: Push to gh-pages branch
        run: |
          cd deploy
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Release v${{ needs.validate.outputs.version }}: ${{ github.sha }}"
          git push -f "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" HEAD:gh-pages

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy

  # Deploy to GitHub Pages
  deploy:
    needs: [validate, build]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Create GitHub Release
  create-release:
    needs: [validate, deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Bump version on main after release
  bump-version:
    needs: [validate, create-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Calculate next dev version
        id: next
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_DEV="${MAJOR}.${MINOR}.${NEXT_PATCH}-dev"
          echo "next_dev=$NEXT_DEV" >> $GITHUB_OUTPUT
          echo "Next dev version: $NEXT_DEV"

      - name: Update VERSION file
        run: |
          NEXT_DEV=${{ steps.next.outputs.next_dev }}
          echo "$NEXT_DEV" > VERSION
          echo "Updated VERSION to: $NEXT_DEV"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bump/${{ steps.next.outputs.next_dev }}
          title: "chore: bump version to ${{ steps.next.outputs.next_dev }}"
          body: |
            Automated version bump after release v${{ needs.validate.outputs.version }}

            ## Changes
            - `VERSION` → `${{ steps.next.outputs.next_dev }}`

            ## What's Next
            This PR should be merged to prepare for the next development cycle.
          commit-message: "chore: bump version to ${{ steps.next.outputs.next_dev }}"
          delete-branch: true
          labels: |
            automated
            version-bump

      - name: Enable auto-merge for bump PR
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge --auto --merge "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
